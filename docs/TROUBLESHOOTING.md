# IT-Invent Bot - Решение проблем

## Содержание

1. [Проблемы с поиском](#проблемы-с-поиском)
2. [Проблемы с перемещением](#проблемы-с-перемещением)
3. [Проблемы с email](#проблемы-с-email)
4. [Проблемы с подсказками](#проблемы-с-подсказками)
5. [Проблемы с базой данных](#проблемы-с-базой-данных)
6. [Проблемы с экспортом](#проблемы-с-экспортом)
7. [Общие проблемы](#общие-проблемы)

---

## Проблемы с поиском

### Серийный номер не распознается с фото

**Симптомы:**
- Бот не может распознать серийный номер
- Сообщение "Серийный номер не распознан"

**Решения:**
1. Убедитесь, что фото четкое и хорошо освещено
2. Серийный номер должен быть хорошо виден
3. Попробуйте ввести серийный номер вручную
4. Проверьте, что OpenRouter API доступен

**Проверка логов:**
```powershell
Select-String -Path bot.log -Pattern "OCR|extract_serial" -Context 2
```

---

### Оборудование не найдено в БД

**Симптомы:**
- "Оборудование не найдено"
- Серийный номер распознан, но нет в БД

**Решения:**
1. Проверьте правильность серийного номера
2. Попробуйте поискать в другой БД (переключите через /database)
3. Используйте функцию "Добавить ненайденное оборудование"
4. Проверьте, что оборудование есть в таблице ITEMS

**SQL-запрос для проверки:**
```sql
SELECT * FROM ITEMS 
WHERE SERIAL_NO LIKE '%ABC123%' 
   OR HW_SERIAL_NO LIKE '%ABC123%'
```

---

### Подсказки не появляются

**Симптомы:**
- При вводе ФИО не показываются подсказки
- Нет списка для выбора

**Решения:**
1. Введите минимум 2 символа
2. Проверьте подключение к БД
3. Убедитесь, что сотрудник есть в таблице OWNERS
4. Проверьте логи на наличие ошибок

**Проверка логов:**
```powershell
Select-String -Path bot.log -Pattern "\[SUGGESTIONS\]|\[SHOW_SUGGESTIONS\]" | Select-Object -Last 20
```

**Ожидаемые логи:**
```
[SHOW_SUGGESTIONS] Вызов для 'Иван', mode=transfer, user_id=123456
[SUGGESTIONS] Запрос подсказок для 'Иван', user_id=123456, limit=8
[SUGGESTIONS] Найдено результатов из find_by_employee: 5
[SUGGESTIONS] Возвращаем 5 подсказок для 'Иван'
```

---

## Проблемы с перемещением

### Акты не создаются

**Симптомы:**
- "Не удалось создать акт"
- PDF-файлы не генерируются

**Решения:**
1. Проверьте наличие шаблона: `templates/transfer_act_template.docx`
2. Убедитесь, что Microsoft Word установлен
3. Проверьте права доступа к папке `transfer_acts/`
4. Проверьте, что библиотека `docx2pdf` установлена

**Проверка:**
```powershell
# Проверка шаблона
Test-Path templates\transfer_act_template.docx

# Проверка папки
Test-Path transfer_acts

# Проверка библиотеки
pip show docx2pdf
```

---

### Файлы актов не найдены при отправке на email

**Симптомы:**
- "Некоторые файлы актов не найдены"
- "Отсутствуют акты для: ..."

**Решение:**
Эта проблема была исправлена в последнем обновлении. Убедитесь, что:
1. Бот перезапущен после обновления
2. Используется актуальная версия кода
3. Проверьте логи на наличие ошибок генерации

**Проверка логов:**
```powershell
Select-String -Path bot.log -Pattern "pdf_path|Акт успешно создан" -Context 2
```

---

### Кнопка "Отправить старым владельцам" не работает

**Симптомы:**
- При нажатии кнопки ничего не происходит
- Нет реакции бота

**Решение:**
1. Перезапустите бота
2. Проверьте, что callback зарегистрирован в main.py
3. Проверьте логи

**Проверка логов:**
```powershell
Select-String -Path bot.log -Pattern "\[ACT_EMAIL\] Получен callback" -Context 2
```

**Ожидаемый лог:**
```
[ACT_EMAIL] Получен callback: act:email_owners
```

---

## Проблемы с email

### Email старого владельца не найден

**Симптомы:**
- "Email не найден в БД"
- Частичная отправка актов

**Решения:**
1. Проверьте наличие email в таблице OWNERS:
   ```sql
   SELECT OWNER_DISPLAY_NAME, OWNER_EMAIL 
   FROM OWNERS 
   WHERE OWNER_DISPLAY_NAME LIKE '%Иванов%'
   ```
2. Добавьте email в БД
3. Используйте опцию "Ввести email вручную"

---

### Ошибка отправки email

**Симптомы:**
- "Ошибка отправки email"
- "Не удалось отправить письмо"

**Решения:**
1. Проверьте доступность SMTP-сервера:
   ```powershell
   Test-NetConnection -ComputerName 10.103.0.51 -Port 25
   ```
2. Проверьте настройки в .env:
   ```bash
   SMTP_SERVER=10.103.0.51
   SMTP_PORT=25
   EMAIL_ADDRESS=noreply@company.com
   ```
3. Проверьте размер вложений (не более 10 МБ)
4. Проверьте корректность email адреса

---

### Некорректный формат email

**Симптомы:**
- "Некорректный формат email адреса"

**Решение:**
Используйте правильный формат:
- ✅ `user@example.com`
- ✅ `user.name@example.com`
- ❌ `user@`
- ❌ `@example.com`
- ❌ `user`

---

## Проблемы с базой данных

### Не удается подключиться к БД

**Симптомы:**
- "База данных не выбрана"
- "Не удалось подключиться к базе данных"

**Решения:**
1. Проверьте доступность SQL Server:
   ```powershell
   Test-NetConnection -ComputerName [server] -Port 1433
   ```
2. Проверьте credentials в .env
3. Проверьте, что ODBC Driver установлен
4. Выберите БД через /database

**Проверка ODBC Driver:**
```powershell
Get-OdbcDriver | Where-Object {$_.Name -like "*SQL Server*"}
```

---

### Ошибка доступа к таблицам

**Симптомы:**
- "Permission denied"
- "Invalid object name"

**Решения:**
1. Проверьте права пользователя ROUser
2. Убедитесь, что таблицы существуют
3. Система использует fallback-запросы для LOCATIONS/BRANCHES

**Проверка прав:**
```sql
-- Проверка доступа к таблицам
SELECT * FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_NAME IN ('ITEMS', 'OWNERS', 'CI_TYPES', 'CI_MODELS')
```

---

## Проблемы с экспортом

### Экспорт не создается

**Симптомы:**
- "Ошибка создания файла"
- Файл не отправляется

**Решения:**
1. Проверьте права доступа к папке `exports/`
2. Проверьте, что библиотеки установлены:
   ```powershell
   pip show pandas openpyxl xlrd
   ```
3. Проверьте наличие данных для экспорта
4. Проверьте логи

---

### Пустой экспорт

**Симптомы:**
- "Нет данных для экспорта"
- Файл пустой

**Решения:**
1. Проверьте фильтры (дата, БД)
2. Убедитесь, что есть данные в JSON-файлах:
   - `data/unfound_equipment.json`
   - `data/equipment_transfers.json`
3. Попробуйте экспорт без фильтров

---

## Общие проблемы

### Бот не отвечает

**Решения:**
1. Проверьте, что бот запущен:
   ```powershell
   Get-Process | Where-Object {$_.ProcessName -like "*python*"}
   ```
2. Проверьте TELEGRAM_BOT_TOKEN в .env
3. Проверьте интернет-соединение
4. Перезапустите бота:
   ```powershell
   .\start_bot.bat
   ```

---

### Бот зависает

**Решения:**
1. Проверьте логи на наличие ошибок
2. Проверьте использование памяти
3. Перезапустите бота
4. Проверьте подключение к БД

---

### Ошибка "Access denied"

**Решения:**
1. Убедитесь, что вы в разрешенной группе
2. Проверьте, что ваш ID в списке ALLOWED_USERS
3. Обратитесь к администратору

---

## Проверка логов

### Просмотр последних логов
```powershell
Get-Content bot.log -Tail 100
```

### Поиск ошибок
```powershell
Select-String -Path bot.log -Pattern "ERROR|Exception" -Context 3 | Select-Object -Last 20
```

### Мониторинг в реальном времени
```powershell
Get-Content bot.log -Wait -Tail 20
```

### Поиск конкретной операции
```powershell
# Поиск перемещений
Select-String -Path bot.log -Pattern "transfer|перемещение" -Context 2

# Поиск отправок email
Select-String -Path bot.log -Pattern "email|отправ" -Context 2

# Поиск подсказок
Select-String -Path bot.log -Pattern "SUGGESTIONS" -Context 1
```

---

## Получение помощи

Если проблема не решена:

1. **Соберите информацию:**
   - Скриншоты ошибок
   - Последние 100 строк логов
   - Описание действий перед ошибкой

2. **Проверьте документацию:**
   - [Руководство пользователя](USER_GUIDE.md)
   - [Описание функций](FEATURES.md)

3. **Обратитесь к администратору:**
   - Предоставьте собранную информацию
   - Укажите время возникновения проблемы
   - Опишите шаги для воспроизведения

---

## Полезные команды

### Перезапуск бота
```powershell
# Остановить (Ctrl+C в окне бота)
# Затем запустить:
.\start_bot.bat
```

### Проверка зависимостей
```powershell
pip list | Select-String -Pattern "telegram|openai|pandas|openpyxl|pyodbc|docx2pdf"
```

### Очистка кэша
```powershell
# Удалить временные файлы
Remove-Item temp_*.jpg -ErrorAction SilentlyContinue
```

### Проверка конфигурации
```powershell
# Проверка .env
Get-Content .env | Select-String -Pattern "TELEGRAM|SQL|SMTP"
```

---

## Связанные документы

- [Руководство пользователя](USER_GUIDE.md)
- [Описание функций](FEATURES.md)
- [История изменений](CHANGELOG.md)
