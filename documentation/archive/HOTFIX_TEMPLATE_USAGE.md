# Hotfix: Использование шаблона для генерации актов

## Дата: 21 октября 2024 - 18:30

---

## Проблема

PDF-акты генерировались программно без использования существующего шаблона `templates/docx_transfer_act.docx`.

---

## Решение

Переработана функция `generate_transfer_act_pdf()` для использования шаблона с плейсхолдерами.

### Структура шаблона

Шаблон `docx_transfer_act.docx` содержит:

**Плейсхолдеры в параграфах:**
- `{{DATE}}` - дата составления акта
- `{{TO_EMPLOYEE}}` - новый сотрудник (кому)
- `{{FROM_EMPLOYEE}}` - старый сотрудник (от кого)

**Таблица оборудования (7 колонок):**
- `{{NO}}` - номер по порядку
- `{{TYPE_NAME}}` - тип оборудования
- `{{MODEL_NAME}}` - модель
- `{{SERIAL_NO}}` - серийный номер
- `{{BATCH_NO}}` - номер партии
- `{{OWNER_DEPT}}` - отдел владельца
- `{{INVENTORY_NO}}` - инвентарный номер

---

## Реализация

### До (программная генерация):
```python
doc = Document()  # Создание с нуля
doc.add_heading('АКТ ПРИЕМА-ПЕРЕДАЧИ ОБОРУДОВАНИЯ', 0)
# ... много кода для создания структуры
```

### После (использование шаблона):
```python
doc = Document(template_path)  # Загрузка шаблона

# Замена плейсхолдеров в параграфах
for paragraph in doc.paragraphs:
    if '{{DATE}}' in paragraph.text:
        paragraph.text = paragraph.text.replace('{{DATE}}', date_str)
    if '{{TO_EMPLOYEE}}' in paragraph.text:
        paragraph.text = paragraph.text.replace('{{TO_EMPLOYEE}}', new_employee)
    if '{{FROM_EMPLOYEE}}' in paragraph.text:
        paragraph.text = paragraph.text.replace('{{FROM_EMPLOYEE}}', old_employee)

# Работа с таблицей
table = doc.tables[0]
# Удаляем строку-шаблон
table._element.remove(table.rows[1]._element)
# Добавляем данные
for item in serials_data:
    row = table.add_row()
    row.cells[0].text = str(idx)
    row.cells[1].text = type_name
    # ... и т.д.
```

---

## Преимущества

1. **Гибкость** - можно изменить дизайн акта в Word без изменения кода
2. **Брендинг** - легко добавить логотип, фирменный стиль
3. **Совместимость** - использует существующий проверенный шаблон
4. **Меньше кода** - не нужно программно создавать структуру

---

## Структура данных

### Входные данные (serials_data):
```python
[
    {
        'serial': 'ABC123',
        'current_employee': 'Иванов И.И.',
        'equipment': {
            'TYPE_NAME': 'Ноутбук',
            'MODEL_NAME': 'Dell Latitude 5420',
            'SERIAL_NO': 'ABC123',
            'BATCH_NO': 'BATCH-001',
            'OWNER_DEPT': 'IT отдел',
            'INV_NO': 'INV-2024-001'
        }
    }
]
```

### Результат:
- DOCX файл с заполненными данными
- PDF файл (после конвертации)
- Сохранение в `transfer_acts/`

---

## Тестирование

1. Перезапустите бота
2. Выполните перемещение оборудования
3. Проверьте созданный PDF:
   - ✅ Дата заполнена
   - ✅ ФИО сотрудников заполнены
   - ✅ Таблица содержит все данные
   - ✅ Форматирование соответствует шаблону

---

## Изменённые файлы

- `bot/services/pdf_generator.py` - полная переработка логики генерации

---

## Настройка шаблона

Чтобы изменить дизайн акта:

1. Откройте `templates/docx_transfer_act.docx` в Word
2. Измените форматирование, добавьте логотип и т.д.
3. Сохраните плейсхолдеры: `{{DATE}}`, `{{TO_EMPLOYEE}}`, `{{FROM_EMPLOYEE}}`
4. Сохраните структуру таблицы (7 колонок)
5. Сохраните файл

Бот автоматически будет использовать обновлённый шаблон!

---

## Статус

✅ **РЕАЛИЗОВАНО**

Теперь акты генерируются из шаблона с сохранением всего форматирования и дизайна.
